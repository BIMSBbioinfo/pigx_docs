<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <title></title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="description" content="">
    <link rel="stylesheet" href="gitbook/style.css">
    <link rel="stylesheet" href="gitbook/website.css">
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  </head>
  <body>
    <div class="book">
      <div class="book-summary">
        <div id="book-search-input" role="search">
          <input type="text" placeholder="Type to search" />
        </div>
        
        <nav class="summary" id="TOC" role="doc-toc">
          <h1 id="summary">Summary</h1>
          <ul>
          <li><a href="README.html">Introduction</a></li>
          <li><a href="pigx-rna-seq.html">PiGx RNA-seq</a>
          <ul>
          <li><a href="pigx-rna-seq.html#introduction">Introduction</a></li>
          <li><a href="pigx-rna-seq.html#installation">Installation</a></li>
          <li><a href="pigx-rna-seq.html#quick-start">Quick start</a></li>
          <li><a href="pigx-rna-seq.html#preparing-the-input">Preparing the input</a></li>
          <li><a href="pigx-rna-seq.html#running-the-pipeline">Running the pipeline</a></li>
          <li><a href="pigx-rna-seq.html#output-description">Output description</a></li>
          <li><a href="pigx-rna-seq.html#troubleshooting">Troubleshooting</a></li>
          <li><a href="pigx-rna-seq.html#questions">Questions</a></li>
          </ul></li>
          <li><a href="pigx-chip-seq.html#pigx-chip-seq">PiGx ChIP-seq</a>
          <ul>
          <li><a href="pigx-chip-seq.html#introduction">Introduction</a></li>
          <li><a href="pigx-chip-seq.html#installation">Installation</a></li>
          <li><a href="pigx-chip-seq.html#quick-start">Quick Start</a></li>
          <li><a href="pigx-chip-seq.html#preparing-input">Preparing Input</a></li>
          <li><a href="pigx-chip-seq.html#running-the-pipeline">Running the Pipeline</a></li>
          <li><a href="pigx-chip-seq.html#output-description">Output Description</a></li>
          <li><a href="pigx-chip-seq.html#troubleshooting">Troubleshooting</a></li>
          <li><a href="pigx-chip-seq.html#questions">Questions</a></li>
          </ul></li>
          <li><a href="pigx-bs-seq.html">PiGx BS-seq</a>
          <ul>
          <li><a href="pigx-bs-seq.html#introduction">Introduction</a></li>
          <li><a href="pigx-bs-seq.html#installation">Installation</a></li>
          <li><a href="pigx-bs-seq.html#quick-start">Quick start</a></li>
          <li><a href="pigx-bs-seq.html#preparing-the-input">Preparing the input</a></li>
          <li><a href="pigx-bs-seq.html#running-the-pipeline">Running the pipeline</a></li>
          <li><a href="pigx-bs-seq.html#output-description">Output description</a></li>
          <li><a href="pigx-bs-seq.html#troubleshooting">Troubleshooting</a></li>
          <li><a href="pigx-bs-seq.html#questions">Questions</a></li>
          </ul></li>
          <li><a href="pigx-scrna-seq.html">PiGx scRNA-seq</a>
          <ul>
          <li><a href="pigx-scrna-seq.html#introduction">Introduction</a></li>
          <li><a href="pigx-scrna-seq.html#installation">Installation</a></li>
          <li><a href="pigx-scrna-seq.html#quick-start">Quick start</a></li>
          <li><a href="pigx-scrna-seq.html#preparing-the-input">Preparing the input</a></li>
          <li><a href="pigx-scrna-seq.html#running-the-pipeline">Running the pipeline</a></li>
          <li><a href="pigx-scrna-seq.html#output-description">Output description</a></li>
          <li><a href="pigx-scrna-seq.html#troubleshooting">Troubleshooting</a></li>
          <li><a href="pigx-scrna-seq.html#questions">Questions</a></li>
          </ul></li>
          <li><a href="pigx-sars-cov-2.html">PiGx SARS-CoV-2</a>
          <ul>
          <li><a href="pigx-sars-cov-2.html#introduction">Introduction</a></li>
          <li><a href="pigx-sars-cov-2.html#installation">Installation</a></li>
          <li><a href="pigx-sars-cov-2.html#quick-start">Quick start</a></li>
          <li><a href="pigx-sars-cov-2.html#preparing-the-input">Preparing the input</a></li>
          <li><a href="pigx-sars-cov-2.html#running-the-pipeline">Running the pipeline</a></li>
          <li><a href="pigx-sars-cov-2.html#output-description">Output description</a></li>
          <li><a href="pigx-sars-cov-2.html#troubleshooting">Troubleshooting</a></li>
          </ul></li>
          </ul>
        </nav>
      </div>

      <div class="book-body">
        <div class="body-inner">
          <div class="book-header" role="navigation">
            <!-- Title -->
            <h1>
              <i class="fa fa-circle-o-notch fa-spin"></i>
              <a href="." ></a>
            </h1>
          </div>
          <div class="page-wrapper" tabindex="-1" role="main">
            <div class="page-inner">
              <div id="book-search-results">
                <div class="search-noresults">
                  <section class="normal markdown-section">
                    <h1 id="pigx-sars-cov-2">PiGx SARS-CoV-2</h1>
                    <h1 id="introduction">Introduction</h1>
                    <p>PiGx SARS-CoV-2 is a pipeline for detecting viral lineages in sequencing data obtained from enriched wastewater samples. It was developed with SARS-CoV-2 as its target virus, but other targets are theoretically possible. The viral lineages are provided by the user together with their characteristic signature mutations. The pipeline is very flexible, allowing the user to choose from multiple input and output files, and giving them fine control about parameters used by the individual tools. PiGx SARS-CoV-2 has been developed with a focus on reproucible outputs, and it can be used for continuous sampling. The output of the PiGx SARS-CoV-2 pipeline is summarized in a report which provides an intuitive visual overview about the development of lineage abundance and single significantly increasing mutations over time and location. In addition, the pipeline will generate more detailed reports per sample, which cover the quality control of the samples, the detected variants, and a taxonomic classification of all unaligned reads. This version of the pipeline was designed to work with paired-end amplicon sequencing data e.g. following the ARtIc protocols <a href="https://github.com/artic-network/artic-ncov2019/tree/master/primer_schemes/nCoV-2019/V3">ARTIC nCoV-2019 primers</a>, but single-end sequencing reads are supported as well.</p>
                    <h2 id="workflow">Workflow</h2>
                    <p>In the first step the pipeline takes the raw reads and the additional information about used primers and adapters to perform extensive quality control. Primer trimming is done with <a href="https://github.com/andersen-lab/ivar">iVAR</a>, and <a href="https://github.com/OpenGene/fastp">fastp</a> is used for adapter trimming and quality filtering. Next, the trimmed reads are aligned to the reference genome of SARS-CoV-2 using <a href="https://github.com/lh3/bwa">BWA</a>, and the results are <em>SAM</em>/<em>BAM</em> files of <strong>aligned</strong> and <strong>unaligned reads</strong>. Following the alignment a quality check on raw and processed reads is performed by using <a href="https://multiqc.info/">MultiQC</a>. Furthermore samples are checked for genome coverage and how many of the provided signature mutation sites are covered. Based on this every samples gets a quality score. Samples with genome coverage below a user defined percentage threshold are reported as discarded samples, as they are not included in time series analysises and summaries.</p>
                    <p>Calling the variants and inferring single nucleotide polymorphisms (SNVs) on the <strong>aligned reads</strong> is done with <a href="https://csb5.github.io/lofreq/">LoFreq</a>. Mutations are annotated with <a href="https://covid-19.ensembl.org/index.html">VEP</a>. Estimation of lineage frequencies is done by deconvolution (see Methods in the realted publication for details). To investigate the abundance of RNA matching other existing species in the wastewater samples the <strong>unaligned reads</strong> will be taxonomicly classified with <a href="https://github.com/DerrickWood/kraken2">Kraken2</a>. Kraken2 requires a database downloaded locally of the genomes against the reads are getting aligned. For documentation how to set this up, see: <a href="#preparing-the-databases">Prepare databases</a>. For a better and interactive visualization of all species present in the wastewater <a href="https://github.com/marbl/Krona/wiki">Krona</a> is used. Also here a small step of setting up a database is needed before running the pipeline, see: <a href="#preparing-the-databases">Prepare databases</a>. Interactive reports are generated using <a href="https://rmarkdown.rstudio.com/">R-markdown</a> and <a href="https://plotly.com/r/">plotly for R</a> for visualizations.</p>
                    <h3 id="pooling-of-samples-for-time-series-analysis-and-plots">Pooling of samples for time series analysis and plots</h3>
                    <p>For summarizing across daytime and location, the lineage frequencies are pooled by calculating the weighted average using the total number of reads of each sample as weights (missing samples are removed).</p>
                    <h2 id="output">Output</h2>
                    <ul>
                    <li>Overview reports including:
                    <ul>
                    <li>Summary and visualization of the development of SARS-CoV-2 variants and mutations over time and locations from all samples provided.</li>
                    <li>Quality Control reports per sample.</li>
                    <li>Per sample variant report: variant analysis of SARS-CoV-2 from each wastewater sample and identification of variants of concern.</li>
                    <li>Taxonomic classification of unaligned reads: Overview over taxa inferred from all the sequencing reads not aligning to the reference genome.</li>
                    </ul></li>
                    <li>Deconvoluted variant abundances</li>
                    <li>Mutation abundances</li>
                    <li>Single nucleotide variation call files</li>
                    <li>VEP reports</li>
                    <li>Kraken2 taxonomic classifications</li>
                    <li>Numerous intermediate read, alignment, and statistics files</li>
                    <li>Log files for all major analysis steps performed by the pipeline</li>
                    </ul>
                    <h1 id="installation">Installation</h1>
                    <p>Pre-built binaries for PiGx are available through <a href="https://gnu.org/s/guix">GNU Guix</a>, the functional package manager for reproducible, user-controlled software management. You can install the PiGx SARS-CoV-2 pipeline with</p>
                    <div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">guix</span> install pigx-sars-cov-2</span></code></pre></div>
                    <p>If you want to install PiGx SARS-CoV-2 from source, please clone this repository and change directory accordingly:</p>
                    <div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/BIMSBbioinfo/pigx_sars-cov-2.git</span>
                    <span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> pigx_sars-cov-2</span></code></pre></div>
                    <p>To fetch code that is common to all PiGx pipelines run this:</p>
                    <div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> submodule update <span class="at">--init</span></span></code></pre></div>
                    <p>Before setting everything up, though, make sure <a href="https://github.com/BIMSBbioinfo/pigx_sars-cov-2/blob/main/manifest.scm">all dependencies</a> are met by either installing them manually, or by entering the provided reproducible Guix environment. If you are using Guix we definitely recommend the latter. This command spawns a sub-shell in which all dependencies are available at exactly the same versions that we used to develop the pipeline:</p>
                    <div class="sourceCode" id="cb4"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="va">USE_GUIX_INFERIOR</span><span class="op">=</span>t <span class="ex">guix</span> environment <span class="at">--pure</span> <span class="at">-m</span> manifest.scm <span class="at">--preserve</span><span class="op">=</span>GUIX_LOCPATH</span></code></pre></div>
                    <p>To use your current Guix channels instead of the fixed set of channels, just omit the <code>USE_GUIX_INFERIOR</code> shell variable:</p>
                    <div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">guix</span> environment <span class="at">--pure</span> <span class="at">-m</span> manifest.scm <span class="at">--preserve</span><span class="op">=</span>GUIX_LOCPATH</span></code></pre></div>
                    <p>Note that <code>--pure</code> unsets all environment variables that are not explicitly preserved. To access other executables that are not part of the environment please address them by their absolute file name.</p>
                    <p>Inside the environment you can then perform the usual build steps:</p>
                    <div class="sourceCode" id="cb6"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./bootstrap.sh</span> <span class="co"># to generate the &quot;configure&quot; script</span></span>
                    <span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span></span>
                    <span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span>
                    <span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> check</span></code></pre></div>
                    <p>At this point you are able to run PiGx SARS-CoV-2. To see all available options type <code>--help</code>.</p>
                    <div class="sourceCode" id="cb7"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pigx-sars-cov-2</span> <span class="at">--help</span></span></code></pre></div>
                    <h2 id="preparing-the-databases">Preparing the databases</h2>
                    <p>Before the pipeline can work, three databases must be downloaded to a location specified in the settings file. Depending on the size of the databases this can take some time.</p>
                    <p>Without any user intervention, this will happen automatically via snakemake rules. This behaviour is controlled via parameters in the settings file. See the <a href="#settings-file">Settings file</a> section for details.</p>
                    <p>Alternatively, the databases may be downloaded maunally via the <code>download_databases.sh</code> scripts accessible like so:</p>
                    <div class="sourceCode" id="cb8"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="va">prefix</span><span class="op">=</span><span class="st">&quot;</span><span class="va">$(</span><span class="fu">dirname</span> pigx-sars-cov-2<span class="va">)</span><span class="st">/../&quot;</span></span>
                    <span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="va">$prefix</span><span class="ex">/libexec/pigx_sars-cov-2/scripts/download_databases.sh</span></span></code></pre></div>
                    <p>However, the <code>download_databases.sh</code> script does not offer the flexibility of downloading the databases automatically with user defined parameters, unless it is manually edited.</p>
                    <p><em>Note: The directory that the databases will be downloaded to needs to match the database directories given in the settings file, else the pipeline will download the databases to the given directory again, unnecessarily using up space. This should be the case by default though.</em></p>
                    <p>Read on for details if you want to download the databases manually.</p>
                    <h3 id="kraken2-database">Kraken2 database</h3>
                    <p>There are several libraries of genomes that can be used to classify the (unaligned) reads. It is up to you which one to use, but be sure that they fulfill the necessities stated by Kraken2 (<a href="https://github.com/DerrickWood/kraken2/wiki/Manual#kraken-2-databases">Kraken2 manual</a>). For an overall overview we recommend to use the Plus-PFP library provided <a href="https://benlangmead.github.io/aws-indexes/k2">here</a>, which is also the default library used in the pipeline. If the classification is not of concern or only the viruses are of interest, we recommend using a smaller one. This will speed up the pipeline.</p>
                    <p>After downloading and unpacking the database files, use <code>kraken2-build</code> to download the taxonomy data and build the database.</p>
                    <h3 id="krona-database">Krona database</h3>
                    <p>The way we use Krona, we only need the taxonomy database, as downloaded via their <code>updateTaxonomy.sh</code> script.</p>
                    <h3 id="vep-database">VEP database</h3>
                    <p>For our use of VEP in the pipeline, we need a pre-indexed cache of the VEP database of transcript models. This is the main point of the pipeline that determines which virus can be analysed with the pipeline. Currently, VEP only has data on SARS-CoV-2. But the VEP cache is the only point strictly determining which virus the pipeline can deal with.</p>
                    <p>Per default the pipeline uses the indexed cache archive at <code>http://ftp.ensemblgenomes.org/pub/viruses/variation/indexed_vep_cache/sars_cov_2_vep_101_ASM985889v3.tar.gz</code>, which only needs to be unpacked to the target directory. Currently this is the only available chache file.</p>
                    <h1 id="quick-start">Quick start</h1>
                    <p>To check whether the pipeline and the databases have been properly set up, run the pipeline on a minimal test dataset.</p>
                    <ol>
                    <li><p>Download the test data</p>
                    <p><code>git clone https://github.com/BIMSBbioinfo/pigx_sars-cov-2 sarscov2-test</code></p></li>
                    <li><p>Enter the directory</p>
                    <p><code>cd sarscov2-test</code></p></li>
                    <li><p>Run the pipeline</p>
                    <p><code>pigx-sars-cov-2 -s tests/tests/setup_test_settings.yaml tests/sample_sheet.csv</code></p></li>
                    </ol>
                    <p>Inside <code>tests/</code> a new directory <code>output_setup_test</code> is created, which includes specific directories containing output data for the respective step of the pipeline. The <code>tests/output_setup_test/reports/index.html</code> gives the overview over all merged reports for the test data.</p>
                    <h1 id="preparing-the-input">Preparing the input</h1>
                    <p>In order to run the pipeline, you need to supply</p>
                    <ul>
                    <li>Sample sheet (CSV format): containing information about sampling date and<br />
                    location</li>
                    <li>Settings file (YAML format) for specifying the experimental setup and optional custom parameter adjustments<br />
                    </li>
                    <li>Mutation sheet containing the lineages of interest and their signature mutations in nucleotide notation (CSV format)<br />
                    </li>
                    <li>Mutation BED file containing the genomic coordinates of the mutation sites (see below for details)<br />
                    </li>
                    <li>Reference genome of the target species in fasta format (so far the pipeline is only optimized for SARS-CoV-2, others might work too but not yet<br />
                    tested)</li>
                    <li>Primer BED file containing the PCR primer locations (e.g the primers suggested from ARTIC protocols)</li>
                    </ul>
                    <p>In order to generate template settings and sample sheet files, type</p>
                    <div class="sourceCode" id="cb9"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pigx-sars-cov-2</span> <span class="at">--init</span></span></code></pre></div>
                    <p>in the shell, and a boilerplate <code>sample_sheet.csv</code> and <code>settings.yaml</code> will be written to your current directory. An example for both files is provided in the <code>tests/</code> directory.</p>
                    <h2 id="sample-sheet">Sample sheet</h2>
                    <p>The sample sheet is a tabular file (<code>csv</code> format) describing the experiment. The table has the following columns:</p>
                    <table>
                    <thead>
                    <tr class="header">
                    <th>SampleName</th>
                    <th>Read</th>
                    <th>Read2</th>
                    <th>date</th>
                    <th>location_name</th>
                    <th>coordinates_lat</th>
                    <th>coordinates_long</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr class="odd">
                    <td>Test0</td>
                    <td>Test0_R1.fastq</td>
                    <td>Test0_R2.fastq</td>
                    <td>2021-01-01T08:00:00</td>
                    <td>Berlin</td>
                    <td>52.364</td>
                    <td>13.509</td>
                    </tr>
                    <tr class="even">
                    <td>Test2</td>
                    <td>Test2_R1.fastq</td>
                    <td>Test2_R2.fastq</td>
                    <td>2021-01-03T08:00:00</td>
                    <td>Munich</td>
                    <td>48.208</td>
                    <td>11.628</td>
                    </tr>
                    </tbody>
                    </table>
                    <ul>
                    <li><em>SampleName</em> is the name for the sample</li>
                    <li><em>Read</em> &amp; <em>Read2</em> are the fastq file names of paired end reads
                    <ul>
                    <li>the location of these files is specified in the settings file</li>
                    <li>in the case of single-end data, leave the <code>Read2</code> column <strong>empty</strong></li>
                    </ul></li>
                    <li><em>date</em> is a date/time in ISO format (<code>yyyy-mm-ddThh:mm:ss</code>)</li>
                    <li><em>location_name</em> is the name of the location and should be unique per coordinates</li>
                    <li><em>coordinates_lat</em> &amp; <em>coordinates_long</em> correspond the latitude and longitude of the location name</li>
                    </ul>
                    <h2 id="mutation-sheet">Mutation sheet</h2>
                    <p>The mutation sheet should contain one column of siganture mutations per lineage that shall be tracked and analysed by deconvolution. They should be given in the format <code>GENE:RxxxV</code>, where <code>GENE</code> is the name of the gene in which the mutation is found, <code>R</code> is a string of reference nucleotides in upper case, <code>xxx</code> is the first reference nucleotides position (a number), and <code>V</code> is a string of variant nucleotides, also in upper case. There is no upper or lower limit for the number of signature mutations per lineage. However, please note that the deconvolution results are more robust and precise with a higher number of mutations. (Tested with 10-30 mutations per lineage).</p>
                    <h2 id="mutation-bed-file">Mutation BED file</h2>
                    <p>The BED file for testing if the mutation sites are covered should have 4<br />
                    columns:</p>
                    <ol>
                    <li>chromosome name<br />
                    </li>
                    <li>start - 5bp <strong>before</strong> the mutation location<br />
                    </li>
                    <li>end - 5bp <strong>after</strong> the mutation location<br />
                    </li>
                    <li>name with the original location of the mutation in the format of: name_MutationLocation_name, e.g: “nCoV-2019_210_SigmutLocation” A row in the BED file should look like:<br />
                    <code>NC_045512.2 205 215 nCoV-2019_210_SigmutLocation</code><br />
                    Please see the example file within the test directory for a detailed example.</li>
                    </ol>
                    <h2 id="primer-bed-file">Primer BED file</h2>
                    <p>The primer file contains the locations of primer sequences on the reads, i.e. it defines where in the genomes primer sequences <em>may</em> occurr. This is determined by the primer scheme used in generating the sequencing reads. It is required by iVar for primer trimming. An example file can be found in the test directory (<code>nCoV-2019_NCref.bed</code>).</p>
                    <h2 id="settings-file">Settings file</h2>
                    <p>The settings file contains parameters (in YAML format) to configure the execution of the PiGx SARS-CoV-2 pipeline. There are generally two settings files at play:</p>
                    <ol>
                    <li>The pipeline interal settings file (source: <code>etc/settings.yaml</code>, installed: <code>$prefix/share/pigx_sars-cov-2/settings.yaml</code>), containing default settings. This file is not supposed to be modified by the user.</li>
                    <li>An analysis specific, user provided settings file containing changes to the default settings. These are generally paths to the input files, databases, etc.</li>
                    </ol>
                    <p>When the pipeline is executed, both settings files are combined into a run specific config file (<code>config.json</code>), used by the internal <code>snakemake</code> workflow manager. It is always generated in the place the <code>pigx-sars-cov-2</code> program was called and will be overwritten on subsequent calls.</p>
                    <details>
                      <summary>Detailed settings explanation.</summary>

                    ### `locations`

                    Paths to various input files and directories needed by the pipeline.

                    * *output-dir* output directory for the pipeline.
                    * *input-dir* direcotry containing the input files, the files therin should
                      match the file suffix given under control/start.
                    * *reference-fasta* [Mutation sheet](#mutation-sheet)
                    * *primers-bed* [Primer BED file](#primer-bed-file)
                    * *mutations-bed* [Mutation BED file](#mutation-bed-file)
                    * *mutation-sheet* [Mutation table](#mutation-sheet)
                    * *kraken-db-dir* [Kraken2 database](#kraken2-database)
                    * *krona-db-dir* [Krona database](#krona-database)
                    * *vep-db-dir* [VEP database](#vep-database)

                    ### `databases`

                    Settings controlling the download and subsequent processing of databases needed
                    for the pipeline. If the databases are already present, none of these settings
                    will have any effect.

                    When prebuilt archives are to be used, the pipeline can download them both via
                    `ftp` and `http`/`https`. If no protocol is included, `http`/`https` is assumed.

                    *Note: Generally the official databases will be used except when running
                    `make check`/`make distcheck` without the databases pre-installed at the default
                    location. In that case the settings file at `tests/settings.yaml` will be used,
                    which configures the pipeline to use database archives prebuilt by us. This is
                    to ensure the github actions can run smoothly. In order to build the archives,
                    at least 1GB of disk space is necessary, which is not given on a github action
                    runner.*

                    #### `kraken2`

                    The kraken2 database download is the most complex of the three database
                    downloads. The download is done via one of the database archive file provided at
                    the [Index Zone](https://benlangmead.github.io/aws-indexes/k2), except in the
                    case outlined above.  
                    When no downsampling should occur, the database archive is extracted and used
                    as-is. In the other case, everything except the hash file (`hash.k2d`) is
                    extracted, the taxonomy is downloaded, and the database is built on disk. The
                    taxonomy files are removed afterwards as they are not used again and only take
                    up space after database building, at least for our purposes.

                    ##### `archive-url`

                    The url the kraken2 archive will be downloaded from. The default archive is the
                    very large database including protozoa and fungi in addition to the standard
                    database.

                    When prebuilt archives are to be used, the pipeline can download them both via
                    `ftp` and `http`/`https`. If no protocol is included, `http`/`https` is assumed.  

                    Default: https://genome-idx.s3.amazonaws.com/kraken/k2_pluspfp_20210127.tar.gz

                    ##### `downsample-db`

                    Whether or not downsampling of the `hash.k2d` file should occurr.  

                    Default: false

                    ##### `max-db-size-bytes`

                    If downsampling should occurr, what is the maximum allowable size in bytes? The
                    resulting file may be smaller than the given value. The value is passed on
                    directly to `kraken2-build` under the `--max-db-size` option. Will only have an
                    effect of `downsample_db` is true.

                    Default: 250000000

                    #### `krona`

                    The Krona database download is fairly simple. Either the Krona internal download
                    script `updateTaxnomy.sh`
                    ([Documentation](https://github.com/marbl/Krona/wiki/Installing)) is used, or a
                    prebuilt archive is downloaded.

                    ##### `use-prebuilt`

                    Whether or not a prebuilt archive should be downloaded instead of running the
                    update taxonomy script.  
                      
                    Default: false

                    ##### `archive-url`

                    If a prebuilt archive should be downloaded, this tells the pipeline where to
                    find it.

                    When prebuilt archives are to be used, the pipeline can download them both via
                    `ftp` and `http`/`https`. If no protocol is included, `http`/`https` is assumed.

                    Default: ""

                    #### `vep`

                    The vep download is the simplest. The database is always in a compressed
                    archive.

                    ##### `archive-url`

                    Location from where the archive will be downloaded.

                    When prebuilt archives are to be used, the pipeline can download them both via
                    `ftp` and `http`/`https`. If no protocol is included, `http`/`https` is assumed.
                      
                    Default: ftp://ftp.ensemblgenomes.org/pub/viruses/variation/indexed_vep_cache/sars_cov_2_vep_101_ASM985889v3.tar.gz

                    ### `parameters`

                    #### `vep`

                    Parameters for rule vep. See documentation about vep arguments `--species`,
                    `--buffer_size`, and `--distance` respectively in the vep
                    [documentation](https://grch37.ensembl.org/info/docs/tools/vep/script/vep_options.html).

                    ##### `species`

                    Needs to match with the downloaded VEP database cache. The `vep` default is
                    "homo_sapiens", which is unlikely to be of use for this pipeline.
                      
                    Directly passed to the `vep` parameter `--species`.
                      
                    Default: sars_cov_2

                    ##### `buffer-size`

                    Number of variants in memory at one time. Trades off between run time and memory
                    usage. The higher, the faster.
                      
                    Directly passed to the `vep` parameter `--buffer-size`.
                      
                    Default: 5000

                    ##### `transcript-distance`

                    Up- and downstream distance of a gene and a transcript which will be classified
                    as an up- or downstream variant.
                      
                    Directly passed to the `vep` parameter `--distance`.
                      
                    Default: 5000

                    ##### `db-version`

                    This specifies a database version, which is needed when the database version
                    differs from the `vep` executable version. By default, `vep` looks for a
                    database version matching its own. This is needed even when using a offline
                    database cache like this pipeline does. Therefore this needs to be adjusted
                    when changing the `vep` database used.
                      
                    Directly passed to the `vep` parameter `--distance`.
                      
                    Default: 101

                    #### `ivar_trimming`

                    Parameters for rule `ivar_primer_trim`. See documentation about ivar arguments
                    `-q`, `-m`, and `-s` respectively in the iVar
                    [documentation](https://andersen-lab.github.io/ivar/html/manualpage.html).
                      
                    `ivar` trimms primers from alignment BED files by first removing the sections
                    listed in a second primer BED file, and then performing quality trimming by
                    sliding a window along each read from 5' to 3' end, clipping the read if the
                    average window quality drops below a given cutoff.

                    ##### `quality-cutoff`

                    If the average base call quality in the sliding window drops below this value,
                    the read will be trimmed to the last base of sufficient average window quality.  

                    Directly passed to the `ivar` parameter `-q`.  

                    Default: 15

                    ##### `length-cutoff`

                    Read length threshold, if a read is shorter than this after trimming, it will be
                    discarded.  

                    Directly passed to the `ivar` parameter `-m`.  
                    Default: 30

                    ##### `window-width`

                    Number of bases in the sliding window, i.e. the window width.
                      
                    Directly passed to the `ivar` parameter `-qs`.
                      
                    Default: 4

                    #### `reporting`

                    These paramerters are used to set quality control filters for the reports.

                    ##### `mutation-coverage-threshold`

                    Results from samples without sufficient coverage measures are not included in
                    the visualizations or the linear regression calculations.
                      
                    Default: 90

                    #### `deconvolution`

                    ##### `method`

                    Control the deconvolution method used.
                    Possible options are:

                    * `rlm`:
                      Robust linear regression as implemented in the `MASS` package, executed
                      via the `deconvR` package.
                    * `nnls`:
                      Non-negative least squares (`deconvR`).
                    * `qp`:
                      Quadratic programming (`deconvR`).
                    * `svr`:
                      Support vector regression (`deconvR`).

                    Prepending "weighted_" to the chosen method will add weighting of bulk mutation
                    abundances per variant by the inverse of the proportion of detected mutations to
                    known mutations. This biases the abundance of variants with high proportions
                    towards higher values, and coversely biases the abundence regression is of
                    variants with low proportions towards lower values.
                      
                    Default: weighted_rlm

                    ##### `mutation-depth-threshold`

                    Minimum sequencing per mutation for it to be used in the analysis.
                      
                    Default: 100

                    ## `control`

                    The following settings control from which point the pipeline starts, which
                    path it follows (i.e. which rules are executed on the way) and where it stops.

                    ##### `start`

                    Start points for the analysis

                    * fastq(.gz): Raw reads in (gzipped) FASTQ format
                    * bam: Unfiltered alignments
                    * vcf: Variant calling files. *Note: Ideally these should have been generated by
                      lofreq. The minimum requirement is that the INFO fields "AF" and "DP" are
                      present. (More details on [here](https://samtools.github.io/hts-specs/))*

                    When using a non-default target, not all rules will be able to run and it won't
                    be possible to generate all reports. The main reasons for this are the missing
                    quality control statistics that are necessary mainly for the final report, and
                    the missing unalinged read files when starting after the alignment step.

                    Default: fastq.gz

                    ##### `targets`

                    Desired results of the analysis. Multiple targets at the same time is possible.

                    * help: Print all rules and their descriptions.
                    * final_reports: Produce a comprehensive report. This is the default target.
                    * devonvolution: Run deconvolution for all provided samples and create a summary
                      table containing abundances from all samples.
                    * lofreq: Call variants and produce .vcf file and overview .csv file.
                    * multiqc: Create MultiQC reports for including raw and trimmed reads.
                      
                    Default: - final_reports

                    ##### `run-ivar-primer-trimming`

                    Whether the primer trimming step should be performed.
                      
                    Default: yes

                    #### `execution`

                    Settings directly related to the program execution itself.

                    ##### `jobs`

                    The number of jobs allowed to be executed at one time. If executed locally this
                    specifies the maximum number of cores used at a time. May not extend to the
                    number of jobs used by individual tools. See section `--cores` & `--jobs` in the
                    [snakemake docs](https://snakemake.readthedocs.io/en/stable/executing/cli.html#all-options)

                    Default: 6

                    ##### `submit-to-cluster`

                    Whether cluster specific settings will be respected, and a qsub submission
                    call should be executed.
                      
                    Default: no

                    ##### `cluster`

                    Settings specific to executing the pipeline on a computing cluster. None of
                    these are relevant when `submit-to-cluster` is "no".

                    ###### `missing-file-timeout`

                    How long before a rule output file is declared missing and the pipeline stopped.

                    When executing the pipeline on a cluster, file system latency can be higher
                    than when the pipeline is executed on a single server. Therefore the time
                    snakemake waits before declaring a rule output file as missing and stopping
                    needs to be adjusted.
                      
                    Default: 120

                    ###### `stack`

                    Stack memory used for each rule. We recommend leaving it as it is, unless you
                    really know what you are doing.
                      
                    Default: 128M

                    ###### `queue`

                    The name of a specific queue the whole pipeline should be submitted to.
                      
                    Default: all

                    ###### `contact-email`

                    How the cluster administration may contact you.
                      
                    Default: none

                    ###### `args`

                    Additional arguments passed to `qsub`, as a single string.
                      
                    Default: ''

                    ##### `rules`

                    Per rule submission settings. Give the rule name as a heading to configure
                    that specific rule.

                    ###### `__default__`

                    Default settings used in absence of rule specific settings.
                      
                    * `threads`: Number of threads. Default is 1.
                    * `memory`: RAM available for the rule, with unit (e.g. "90K", "5M"). In the
                      case of no unit, unit M is assumed. Default is 4G.

                    ### `tools`

                    Overwrites for locations of specific tools used. Each tool has its own
                    subheading, i.e. "bwa", and the following settings:

                    #### `executable`

                    Path to the executable file for the tool, defaults to the system installation.

                    #### `arguments`

                    Additional arguments to the tool as one string. Only use this if you know
                    what you are doing, these may cause conflicts with the arguments supplied in
                    each rule.

                    </details>
                    <h1 id="running-the-pipeline">Running the pipeline</h1>
                    <p>PiGx SARS-CoV-2 wastewater is executed using the command <code>pigx-sars-cov-2 -s settings.yaml sample_sheet.csv</code>. See <code>pigx-sars-cov-2 --help</code> for information about additional command line arguments.</p>
                    <p>The <code>execution</code> section of the settings file provides some control over the execution of the pipeline.</p>
                    <h2 id="local--cluster-execution">Local / cluster execution</h2>
                    <p>The workflow may be executed locally (on a single computer), or, if a Sun Grid Engine-compatible HPC environment is available, supports cluster execution. In order to enable cluster execution, specify <code>submit-to-cluster: yes</code> in the settings file.</p>
                    <h2 id="parallel-execution">Parallel execution</h2>
                    <p>If the workflow is run on a cluster, or a single computer with sufficient resources, some of the tasks may be computed in parallel. To specify the allowed level or parallelism, set the <code>jobs</code> setting under <code>execution</code> in the settings file. For instance,</p>
                    <div class="sourceCode" id="cb10"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">execution</span><span class="kw">:</span></span>
                    <span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">submit-to-cluster</span><span class="kw">:</span><span class="at"> </span><span class="ch">yes</span></span>
                    <span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">jobs</span><span class="kw">:</span><span class="at"> </span><span class="dv">40</span></span></code></pre></div>
                    <p>in the settings file, will submit up to 40 simultaneous compute jobs on the cluster.</p>
                    <h1 id="output-description">Output description</h1>
                    <p>PiGx SARS-CoV-2 wastewater creates an output directory, as specified in the settings file, that contains all of the following outputs.</p>
                    <h2 id="time-series-reports">Time series reports</h2>
                    <p>This pipeline performs mutation analysis of SARS-CoV-2 and reports and quantifies the occurrence of <em>variants of concern</em> (VOC) and signature mutations by which they are characterised.</p>
                    <p>The visualizations in the time series report provide an overview of the evolution of VOCs and signature mutations found in the analyzed samples across given time points and locations. The abundance values for the variants are derived by deconvolution. The frequencies of the mutations are the output of <a href="https://csb5.github.io/lofreq/">LoFreq</a>.</p>
                    <h2 id="quality-control">Quality control</h2>
                    <p>A quality control report is generated for each sample. It includes reports on amplicon coverage and read coverage, as well as general quality control and preprocessing metrics.</p>
                    <p>General quality control metrics are computed using <a href="https://www.bioinformatics.babraham.ac.uk/projects/fastqc/">FastQC</a> and <a href="https://multiqc.info/">MultiQC</a>. The MultiQC report is particularly useful, collating quality control metrics from many steps of the pipeline in a single HTML report, which may be found under the <code>multiqc</code> directory in the PiGx output folder.</p>
                    <h2 id="taxonomic-classification">Taxonomic classification</h2>
                    <p>This report provides an overview of the species found in the provided wastewater samples apart from SARS-CoV-2. The SARS-CoV-2 enriched wastewater samples are aligned to the virus genome. It provides insight about possible biases and contamination of the samples. In case of abundance of species very similar to SARS-CoV-2 only the taxonomic family will be reported which could indicate that an identification/alignment of SARS-CoV-2 could be biased or impossible. In case of a high percentage of read matching SARS-CoV-2 a refining of trimming parameters should be considered.</p>
                    <h2 id="variant-report">Variant report</h2>
                    <p>This report shows the variant analysis of SARS-CoV-2 from wastewater samples. Mutations are identified by single-nucleotide-variant (SNV) calling performed by <a href="https://csb5.github.io/lofreq/">LoFreq</a>. Translated to amino acid mutations by using <a href="https://covid-19.ensembl.org/info/docs/tools/vep/index.html">Ensemble VEP - COVID-19</a>. The list of found mutations (including synonymous and non-synonymous mutations) were matched against lists of signature mutations characterising variants of concern (VOC) of SARS-CoV-2 provided by <a href="https://outbreak.info/situation-reports">outbreak.info</a> and <a href="https://covariants.org/variants/S.501Y.V1">CoVariant.org</a>.</p>
                    <details>
                      <summary>All outputs with their locations.</summary>

                    *Given locations are relative to the output directory. `SAMPLE` indicates a
                    variable part of a path that will be replaced with a sample name. `VIRUS`
                    will be replaced with the virus being investigated.*

                    * Overview reports:
                      * Summary and visualization of the development of SARS-CoV-2 variants and
                        mutations over time and locations from all samples provided
                        (`report/index.html`).
                      * Quality Control reports per sample:
                        * Overall QC report with number of covered amplicons, read coverage, etc
                          (`report/SAMPLE.qc_report_per_sample.html`).
                        * MultiQC report per sample for raw and trimmed reads along with several
                          supplementary files (`report/multiqc/SAMPLE/*`).
                        * FASTQC reports per sample and read for raw reads, adapter trimmed reads,
                          and aligned reads, along with an archive of supplementary files
                          (`report/fastqc/SAMPLE/*`).
                        * FASTP reports per sample on adapter trimming statistics
                          (`fastp/SAMPLE/*`).
                      * Per sample variant report: variant analysis of SARS-CoV-2 from each
                        wastewater sample and identification of variants of concern
                        (`report/SAMPLE.qc_report_per_sample.html`).
                      * Taxonomic classification of unaligned reads: Overview over taxa inferred
                        from all the sequencing reads not aligning to the reference genome
                        (`report/SAMPLE.taxonomic_classification.html`).
                    * Alignments:
                      * Per sample aligned reads: Reads aligned against the
                        reference genome, at various stages of trimming and sorting, along with
                        their index files (`mapped_reads/SAMPLE_aligned.(bam|sam|bai)`).
                      * Per sample unaligned reads: Reads not aligning to the
                        reference genome (`mapped_reads/SAMPLE_unalingned.(bam|fastq)`).
                    * SNV files:
                      * Per sample files listing all detected single nucleotide variants (SNVs) from
                        the aligned reads (also parsed to csv, `variants/SAMPLE_snv.(vcf|csv)`).
                    * VEP reports:
                      * Per sample report files constituting the
                        [VEP output](https://www.ensembl.org/info/docs/tools/vep/vep_formats.html#output)
                        including the variants uploaded to the VEP database, resulting amino acid
                        changes and consequences for the corresponding protein.
                        * Raw VEP output (`variants/SAMPLE_vep_VIRUS.txt`).
                        * Report with detailed run statistics
                          (`variants/SAMPLE_vep_VIRUS.txt_summary.html`).
                        * Warnings generated by vep during the run
                          (`variants/SAMPLE_vep_VIRUS.txt_warnings.txt`)
                        * File with most of the raw output parsed into a comma separated table for
                          downstream processing (`variants/SAMPLE_vep_VIRUS_parsed.csv`).
                    * Deconvoluted variant abundances:
                      * Per sample abundance of each of the VOCs as
                        * a regular table (`variants/SAMPLE_variant_abundance.csv`),
                        * in a single row together with metadata (used later to construct summary,
                          `variants/SAMPLE_variants_with_meta.csv`).
                      * Overall summary table of per sample variant abundances with
                        sample metadata (`variants/data_variant_plot.csv`).
                    * Mutation abundances:
                      * Per sample abundance of each signature mutation found and meeting the read
                        depth threshold criterium as a single row together with metadata (used later
                        to construct summary, `mutations/SAMPLE_mutations.csv`).
                      * Overall summary table *CSV* file of per sample mutation abundances with
                        sample metadata.
                      * Mutation data of non-signature mutations meeting the read depth threshold
                        (`mutations/SAMPLE_non_sigmuts.csv`).
                    * Sample quality:
                      * Per sample tables of read depth at each signature mutation locus, derived
                        from the *untrimmed* alignment (`coverage/SAMPLE_genome_cov.tsv`).
                      * Per sample tables giving coverage statistics of the *untrimmed* alignment
                        (`coverage/SAMPLE_mut_cov.tsv`).
                      * Per sample tables aggregating the statistics of genome and mutation coverage
                        files in a sample quality table (single row for downstream use,
                        `coverage/SAMPLE_quality.csv`).
                      * Overall table concatenating the per sample quality rows into one table
                        (`coverage/sample_quality_table.csv`).
                    * Adapter-trimmed reads (`trimmed_reads/SAMPLE_trimmed.fastq.gz`).
                    * Kraken2 raw output: provides an overview of all found species in the unaligned
                      reads together with the NCBI taxonomy ID
                      (`kraken/SAMPLE_classified_unaligned_reads.txt`).
                    * Per sample Krona diagram of taxa proportions in unaligned reads
                      (`report/SAMPLE.Krona_report.html`).
                    * Mutation count summary table containing count statistics for mutations
                      overall and per sample (`mutation_counts.csv`).
                    * Raw table of per mutation linear model coefficients and their p-values,
                      generated by the `mutation_regression.R` script
                      (`unfiltered_mutations_sig.csv`).
                    * Sample summary table containing various statistics about each sample
                      (`overview_QC.csv`).
                    * Log files for all major analysis steps performed by the pipeline
                      (`logs/*.log`).

                    </details>
                    <h1 id="troubleshooting">Troubleshooting</h1>
                    <p>If you have any questions please e-mail: <a href="mailto:pigx@googlegroups.com" class="email">pigx@googlegroups.com</a> or use the web form to ask questions <a href="https://groups.google.com/forum/#!forum/pigx/" class="uri">https://groups.google.com/forum/#!forum/pigx/</a>.</p>
                    <p>If you run into any bugs, please open an issue here: <a href="https://github.com/BIMSBbioinfo/pigx_rnaseq/issues" class="uri">https://github.com/BIMSBbioinfo/pigx_rnaseq/issues</a>.</p>
                  </section>
                </div>
                <div class="search-results">
                  <div class="has-results">
                    <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
                    <ul class="search-results-list"></ul>
                  </div>
                  <div class="no-results">
                    <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
          gitbook.page.hasChanged(
            {
              "page":
              {
                "title":"",
                "level":"1.1",
                "depth":1,
                "next":{},
                "dir":"ltr"
              },
              "config":
              {
                "gitbook":"*",
                "theme":"default",
                "variables":{},
                "plugins":[],
                "pluginsConfig":
                {
                  "highlight":{},
                  "search":{},
                  "lunr": {
                    "maxIndexSize":1000000,
                    "ignoreSpecialCharacters":false
                  },
                  "sharing": {
                    "facebook":true,
                    "twitter":true,
                    "google":false,
                    "weibo":false,
                    "instapaper":false,
                    "vk":false,
                    "all":[
                      "facebook",
                      "google",
                      "twitter",
                      "weibo",
                      "instapaper"
                    ]},
                  "fontsettings": {
                    "theme":"white",
                    "family":"sans",
                    "size":2
                  },
                  "theme-default": {
                    "styles": {
                      "website":"styles/website.css",
                      "pdf":"styles/pdf.css",
                      "epub":"styles/epub.css",
                      "mobi":"styles/mobi.css",
                      "ebook":"styles/ebook.css",
                      "print":"styles/print.css"
                    },
                    "showLevel":false
                  }
                },
                "structure": {
                  "langs":"LANGS.md",
                  "readme":"README.md",
                  "glossary":"GLOSSARY.md",
                  "summary":"SUMMARY.md"
                },
                "pdf": {
                  "pageNumbers":true,
                  "fontSize":12,
                  "fontFamily":"Arial",
                  "paperSize":"a4",
                  "chapterMark":"pagebreak",
                  "pageBreaksBefore":"/",
                  "margin": {
                    "right":62,"left":62,"top":56,"bottom":56
                  }
                },
                "styles": {
                  "website":"styles/website.css",
                  "pdf":"styles/pdf.css",
                  "epub":"styles/epub.css",
                  "mobi":"styles/mobi.css",
                  "ebook":"styles/ebook.css",
                  "print":"styles/print.css"
                }
              },
              "file": {
                "path":"",
                "mtime":"",
                "type":"markdown"
              },
              "gitbook": {
                "version":"3.2.3",
                "time":"2019-07-08T15:24:30.549Z"
              },
              "basePath":".",
              "book": {"language":""}});
        });
    </script>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    <script src="gitbook/gitbook-plugin-search/search-engine.js"></script>
    <script src="gitbook/gitbook-plugin-search/search.js"></script>
    <script src="gitbook/gitbook-plugin-lunr/lunr.js"></script>
    <script src="gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
    <script src="gitbook/gitbook-plugin-sharing/buttons.js"></script>
    <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
  </body>
</html>
